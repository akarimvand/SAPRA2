<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ساپرا بات</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazir:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body,html {margin:0;padding:0;height:100%;font-family:'Vazir', sans-serif;direction:rtl;color:#fff;overflow:hidden;}
    #vanta-bg {position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;}
    .chat-container {display:flex;flex-direction:column;height:100%;max-width:600px;margin:auto;background:rgba(0,0,0,0.6);border-radius:16px;overflow:hidden;box-shadow:0 0 25px rgba(0,0,0,0.7);}
    .chat-messages {flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;}
    .message {max-width:80%;padding:12px 16px;border-radius:18px;line-height:1.6;font-size:15px;word-wrap:break-word;animation:fadeIn 0.3s ease;}
    .user {align-self:flex-end;background:#1976d2;color:#fff;border-bottom-right-radius:4px;}
    .bot {align-self:flex-start;background:#2e7d32;color:#fff;border-bottom-left-radius:4px;}
    .chat-input {display:flex;position:sticky;bottom:0;padding:10px;background:rgba(0,0,0,0.7);}
    .chat-input input {flex:1;padding:10px;border:none;border-radius:12px;outline:none;font-family:'Vazir',sans-serif;}
    .chat-input button {margin-left:10px;background:#ff9800;border:none;color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer;font-family:'Vazir',sans-serif;transition:background 0.2s;}
    .chat-input button:hover {background:#f57c00;}
    .export-btn {background:#9c27b0;color:#fff;border:none;padding:8px 14px;margin:10px;border-radius:12px;cursor:pointer;font-family:'Vazir',sans-serif;align-self:flex-start;}
    .loader {align-self:center;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes fadeIn {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
  </style>
</head>
<body>
<div id="vanta-bg"></div>
<div class="chat-container">
  <button class="export-btn" onclick="exportChat()">📄 خروجی Word</button>
  <div class="chat-messages" id="chat"></div>
  <form class="chat-input" id="chat-form">
    <input type="text" id="user-input" placeholder="پیامتان را بنویسید...">
    <button type="submit">ارسال</button>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta/dist/vanta.waves.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.1.0/docx.min.js"></script>
<script>
VANTA.WAVES({el:'#vanta-bg',mouseControls:true,touchControls:true,minHeight:200.00,minWidth:200.00,scale:1.0,scaleMobile:1.0,color:0x0a3d62,shininess:30,waveHeight:20,waveSpeed:1.0,zoom:0.85});

const chat=document.getElementById('chat');
const form=document.getElementById('chat-form');
const input=document.getElementById('user-input');
const API_KEY="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";
const API_URL="https://openrouter.ai/api/v1/chat/completions";
let messages=[];

function addMessage(text,sender,loading=false){
  const div=document.createElement('div');
  div.className='message '+sender;
  if(loading){
    const loader=document.createElement('div');
    loader.className='loader';
    div.appendChild(loader);
  } else div.innerText=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  if(!loading) messages.push({sender,text});
  return div;
}

async function sendToAPI(userText, messageDiv){
  try{
    const res=await fetch(API_URL,{method:'POST',headers:{'Authorization':`Bearer ${API_KEY}`,'Content-Type':'application/json'},body:JSON.stringify({model:"deepseek/deepseek-chat",messages:[{role:"system",content:"شما یک متخصص نفت و گاز و پتروشیمی هستید."},{role:"user",content:userText}]})});
    const data=await res.json();
    const reply=data.choices[0].message.content;
    messageDiv.innerHTML='';
    messageDiv.innerText=reply;
    messages.push({sender:'bot',text:reply});
  }catch(err){messageDiv.innerText="⚠️ خطا در اتصال";}
}

form.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text) return;
  input.value='';
  addMessage(text,'user');
  const botDiv=addMessage('', 'bot', true);
  await sendToAPI(text, botDiv);
});

// initial greeting
addMessage('سلام! من **ساپرا بات** هستم، متخصص نفت و گاز و پتروشیمی. سوالاتتان را از من بپرسید.','bot');

async function exportChat(){
  const {Document,Packer,Paragraph,TextRun}=docx;
  const doc=new Document({sections:[{properties:{},children:messages.map(m=>new Paragraph({children:[new TextRun({text:(m.sender==='user'?'کاربر: ':'متخصص: ')+m.text,font:"Vazir",size:24})]}))}]});
  const blob=await Packer.toBlob(doc);
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download='chat.docx';
  link.click();
}
</script>
</body>
</html>
