<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punch List Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #1abc9c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--secondary-color), #34495e);
            color: white;
            padding: 25px 0;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            padding: 15px;
        }
        
        #dataGrid {
            height: 500px;
            width: 100%;
            border-radius: 0 0 10px 10px;
        }
        
        .summary-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .summary-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .total-issues {
            background: linear-gradient(135deg, var(--primary-color), #5dade2);
        }
        
        .remaining {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }
        
        .released {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }
        
        .recent-activity {
            background: linear-gradient(135deg, var(--warning-color), #f5b041);
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .last-updated {
            font-size: 12px;
            color: #7f8c8d;
            text-align: right;
            margin-top: 10px;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }
        
        .subsystem-toggle {
            margin-left: 15px;
            font-size: 0.9rem;
        }
        
        .subsystem-badge {
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .subsystem-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        
        .subsystem-active {
            background-color: #3498db !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-clipboard-list me-2"></i> Punch List Management Dashboard</h1>
                    <p class="mb-0">Comprehensive overview of punch list items by discipline, category, and sub-system</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm me-2" id="exportAllBtn"><i class="fas fa-download me-1"></i> Export</button>
                    <button class="btn btn-light btn-sm"><i class="fas fa-cog me-1"></i> Settings</button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="summary-card total-issues">
                    <div class="summary-icon"><i class="fas fa-tasks"></i></div>
                    <div class="summary-value" id="totalIssues">-</div>
                    <div class="summary-label">Total Issues</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card remaining">
                    <div class="summary-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="summary-value" id="totalRemaining">-</div>
                    <div class="summary-label">Total Remaining</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card released">
                    <div class="summary-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="summary-value" id="totalReleased">-</div>
                    <div class="summary-label">Total Released</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card recent-activity">
                    <div class="summary-icon"><i class="fas fa-bolt"></i></div>
                    <div class="summary-value" id="recentIssued">-</div>
                    <div class="summary-label">Issued Last 30 Days</div>
                </div>
            </div>
        </div>

        <!-- Tabs for different views -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discipline-tab" data-bs-toggle="tab" data-bs-target="#discipline" type="button" role="tab">By Discipline</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab">By Category</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="subsystem-tab" data-bs-toggle="tab" data-bs-target="#subsystem" type="button" role="tab">By Sub-System</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">Trends</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="dashboardTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <span><i class="fas fa-chart-pie me-2"></i>Status Distribution</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showPercentages" checked>
                                    <label class="form-check-label" for="showPercentages">Show %</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="statusPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <span><i class="fas fa-chart-bar me-2"></i>Issues by Discipline & Category</span>
                                <select class="form-select form-select-sm" id="stackedBarMetric" style="width: 150px; display: inline-block;">
                                    <option value="Total_Issued">Total Issues</option>
                                    <option value="Remaining">Remaining</option>
                                    <option value="Total_Released">Released</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="disciplineCategoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <span><i class="fas fa-table me-2"></i>Detailed Punch List Data</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-light me-2" id="exportBtn"><i class="fas fa-download me-1"></i>Export</button>
                                    <div class="form-check form-switch d-inline-block subsystem-toggle">
                                        <input class="form-check-input" type="checkbox" id="showSubsystems">
                                        <label class="form-check-label" for="showSubsystems">Show Sub-Systems</label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="dataGrid" class="ag-theme-alpine"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Discipline Tab -->
            <div class="tab-pane fade" id="discipline" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line me-2"></i>Issues by Discipline
                                <div class="form-check form-switch d-inline-block subsystem-toggle">
                                    <input class="form-check-input" type="checkbox" id="showDisciplineSubsystems">
                                    <label class="form-check-label" for="showDisciplineSubsystems">Show Sub-Systems</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="disciplineSubsystems" class="subsystem-container"></div>
                                <div class="chart-container">
                                    <canvas id="disciplineBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-percentage me-2"></i>Completion Rate by Discipline
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="completionRateChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Category Tab -->
            <div class="tab-pane fade" id="category" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i>Issues by Category
                                <div class="form-check form-switch d-inline-block subsystem-toggle">
                                    <input class="form-check-input" type="checkbox" id="showCategorySubsystems">
                                    <label class="form-check-label" for="showCategorySubsystems">Show Sub-Systems</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="categorySubsystems" class="subsystem-container"></div>
                                <div class="chart-container">
                                    <canvas id="categoryBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-pie me-2"></i>Remaining Issues by Category
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="remainingPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Sub-System Tab -->
            <div class="tab-pane fade" id="subsystem" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i>Top Sub-Systems by Issues
                                <select class="form-select form-select-sm" id="subsystemMetric" style="width: 150px; display: inline-block;">
                                    <option value="Total_Issued">Total Issues</option>
                                    <option value="Remaining">Remaining</option>
                                    <option value="Total_Released">Released</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="subsystemBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-table me-2"></i>Sub-System Details
                            </div>
                            <div class="card-body p-0">
                                <div id="subsystemGrid" class="ag-theme-alpine"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div class="tab-pane fade" id="trends" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line me-2"></i>Recent Activity Trends
                                <select class="form-select form-select-sm" id="trendTimeFrame" style="width: 150px; display: inline-block;">
                                    <option value="30">Last 30 Days</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="1">Today</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="activityTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="last-updated">
            <i class="fas fa-sync-alt me-1"></i> Last updated: <span id="lastUpdated">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let gridData = [];
        let charts = {};
        let currentView = 'overview';
        let activeSubsystems = {
            discipline: [],
            category: []
        };
        
        // Load data from CSV
        function loadData() {
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'loading-spinner';
            loadingSpinner.innerHTML = '<div class="spinner-border text-primary spinner" role="status"><span class="visually-hidden">Loading...</span></div>';
            document.getElementById('dataGrid').replaceWith(loadingSpinner);
            
            Papa.parse('pnc2.csv', {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    gridData = results.data.map(item => {
                        return {
                            subSystem: item.ITEM_Sub_System,
                            discipline: item.PL_Discipline,
                            category: item.Category,
                            issued: parseInt(item.Total_Issued),
                            released: parseInt(item.Total_Released),
                            remaining: parseInt(item.Remaining),
                            releasedToday: parseInt(item.Released_Today),
                            released7: parseInt(item.Released_Last_7_Days),
                            released30: parseInt(item.Released_Last_30_Days),
                            issuedToday: parseInt(item.Issued_Today),
                            issued7: parseInt(item.Issued_Last_7_Days),
                            issued30: parseInt(item.Issued_Last_30_Days),
                            completionRate: (parseInt(item.Total_Released) / parseInt(item.Total_Issued) * 100).toFixed(1)
                        };
                    });
                    
                    // Update summary cards
                    updateSummaryCards();
                    
                    // Initialize charts
                    initCharts();
                    
                    // Initialize grids
                    initMainGrid();
                    initSubsystemGrid();
                    
                    // Initialize subsystem filters
                    initSubsystemFilters();
                    
                    // Update last updated time
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                },
                error: function(error) {
                    console.error('Error loading CSV:', error);
                    document.getElementById('dataGrid').innerHTML = '<div class="alert alert-danger">Error loading data. Please try again later.</div>';
                }
            });
        }
        
        // Update summary cards
        function updateSummaryCards() {
            const totalIssues = gridData.reduce((sum, item) => sum + item.issued, 0);
            const totalReleased = gridData.reduce((sum, item) => sum + item.released, 0);
            const totalRemaining = gridData.reduce((sum, item) => sum + item.remaining, 0);
            const recentIssued = gridData.reduce((sum, item) => sum + item.issued30, 0);
            
            document.getElementById('totalIssues').textContent = totalIssues.toLocaleString();
            document.getElementById('totalReleased').textContent = totalReleased.toLocaleString();
            document.getElementById('totalRemaining').textContent = totalRemaining.toLocaleString();
            document.getElementById('recentIssued').textContent = recentIssued.toLocaleString();
        }
        
        // Initialize charts
        function initCharts() {
            // Status Pie Chart
            const totalIssues = gridData.reduce((sum, item) => sum + item.issued, 0);
            const totalReleased = gridData.reduce((sum, item) => sum + item.released, 0);
            const totalRemaining = gridData.reduce((sum, item) => sum + item.remaining, 0);
            
            charts.statusPie = new Chart(
                document.getElementById('statusPieChart').getContext('2d'),
                {
                    type: 'pie',
                    data: {
                        labels: ['Released', 'Remaining'],
                        datasets: [{
                            data: [totalReleased, totalRemaining],
                            backgroundColor: ['#2ecc71', '#e74c3c'],
                            borderWidth: 1
                        }]
                    },
                    options: getPieChartOptions('Status Distribution')
                }
            );
            
            // Discipline-Category Stacked Bar Chart
            charts.disciplineCategory = new Chart(
                document.getElementById('disciplineCategoryChart').getContext('2d'),
                {
                    type: 'bar',
                    data: getStackedBarData('Total_Issued'),
                    options: getStackedBarOptions('Issues by Discipline and Category')
                }
            );
            
            // Discipline Bar Chart
            charts.disciplineBar = new Chart(
                document.getElementById('disciplineBarChart').getContext('2d'),
                {
                    type: 'bar',
                    data: getDisciplineBarData(),
                    options: getBarChartOptions('Issues by Discipline')
                }
            );
            
            // Completion Rate Chart
            charts.completionRate = new Chart(
                document.getElementById('completionRateChart').getContext('2d'),
                {
                    type: 'bar',
                    data: getCompletionRateData(),
                    options: getPercentageBarOptions('Completion Rate by Discipline (%)')
                }
            );
            
            // Category Bar Chart
            charts.categoryBar = new Chart(
                document.getElementById('categoryBarChart').getContext('2d'),
                {
                    type: 'bar',
                    data: getCategoryBarData(),
                    options: getBarChartOptions('Issues by Category')
                }
            );
            
            // Remaining Pie Chart
            charts.remainingPie = new Chart(
                document.getElementById('remainingPieChart').getContext('2d'),
                {
                    type: 'pie',
                    data: getRemainingPieData(),
                    options: getPieChartOptions('Remaining Issues by Category')
                }
            );
            
            // Sub-System Bar Chart
            charts.subsystemBar = new Chart(
                document.getElementById('subsystemBarChart').getContext('2d'),
                {
                    type: 'bar',
                    data: getSubsystemBarData('Total_Issued'),
                    options: getBarChartOptions('Top Sub-Systems by Issues')
                }
            );
            
            // Activity Trend Chart
            charts.activityTrend = new Chart(
                document.getElementById('activityTrendChart').getContext('2d'),
                {
                    type: 'line',
                    data: getActivityTrendData(30),
                    options: getLineChartOptions('Recent Activity Trends')
                }
            );
            
            // Add event listeners for interactive controls
            document.getElementById('showPercentages').addEventListener('change', function() {
                charts.statusPie.options.plugins.datalabels.display = this.checked;
                charts.statusPie.update();
                charts.remainingPie.options.plugins.datalabels.display = this.checked;
                charts.remainingPie.update();
            });
            
            document.getElementById('stackedBarMetric').addEventListener('change', function() {
                charts.disciplineCategory.data = getStackedBarData(this.value);
                charts.disciplineCategory.update();
            });
            
            document.getElementById('subsystemMetric').addEventListener('change', function() {
                charts.subsystemBar.data = getSubsystemBarData(this.value);
                charts.subsystemBar.update();
            });
            
            document.getElementById('trendTimeFrame').addEventListener('change', function() {
                charts.activityTrend.data = getActivityTrendData(parseInt(this.value));
                charts.activityTrend.update();
            });
            
            // Sub-system toggle switches
            document.getElementById('showDisciplineSubsystems').addEventListener('change', function() {
                const container = document.getElementById('disciplineSubsystems');
                if (this.checked) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    activeSubsystems.discipline = [];
                    updateDisciplineCharts();
                }
            });
            
            document.getElementById('showCategorySubsystems').addEventListener('change', function() {
                const container = document.getElementById('categorySubsystems');
                if (this.checked) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    activeSubsystems.category = [];
                    updateCategoryCharts();
                }
            });
            
            // Tab change event to track current view
            document.getElementById('dashboardTabs').addEventListener('shown.bs.tab', function(event) {
                currentView = event.target.getAttribute('data-bs-target').replace('#', '');
            });
        }
        
        // Initialize subsystem filters
        function initSubsystemFilters() {
            const disciplineSubsystems = [...new Set(gridData.map(item => item.discipline))];
            const categorySubsystems = [...new Set(gridData.map(item => item.category))].sort();
            
            // Discipline subsystems
            const disciplineContainer = document.getElementById('disciplineSubsystems');
            disciplineContainer.innerHTML = '<h6>Filter by Sub-System:</h6>';
            
            disciplineSubsystems.forEach(discipline => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary subsystem-badge';
                badge.textContent = discipline;
                badge.addEventListener('click', function() {
                    this.classList.toggle('subsystem-active');
                    
                    if (this.classList.contains('subsystem-active')) {
                        if (!activeSubsystems.discipline.includes(discipline)) {
                            activeSubsystems.discipline.push(discipline);
                        }
                    } else {
                        activeSubsystems.discipline = activeSubsystems.discipline.filter(d => d !== discipline);
                    }
                    
                    updateDisciplineCharts();
                });
                disciplineContainer.appendChild(badge);
            });
            
            // Category subsystems
            const categoryContainer = document.getElementById('categorySubsystems');
            categoryContainer.innerHTML = '<h6>Filter by Sub-System:</h6>';
            
            categorySubsystems.forEach(category => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary subsystem-badge';
                badge.textContent = `Category ${category}`;
                badge.addEventListener('click', function() {
                    this.classList.toggle('subsystem-active');
                    
                    if (this.classList.contains('subsystem-active')) {
                        if (!activeSubsystems.category.includes(category)) {
                            activeSubsystems.category.push(category);
                        }
                    } else {
                        activeSubsystems.category = activeSubsystems.category.filter(c => c !== category);
                    }
                    
                    updateCategoryCharts();
                });
                categoryContainer.appendChild(badge);
            });
        }
        
        // Update discipline charts based on subsystem filters
        function updateDisciplineCharts() {
            charts.disciplineBar.data = getDisciplineBarData();
            charts.disciplineBar.update();
            
            charts.completionRate.data = getCompletionRateData();
            charts.completionRate.update();
        }
        
        // Update category charts based on subsystem filters
        function updateCategoryCharts() {
            charts.categoryBar.data = getCategoryBarData();
            charts.categoryBar.update();
            
            charts.remainingPie.data = getRemainingPieData();
            charts.remainingPie.update();
        }
        
        // Chart data functions
        function getStackedBarData(metric) {
            const disciplines = [...new Set(gridData.map(item => item.discipline))];
            const categories = [...new Set(gridData.map(item => item.category))].sort();
            
            return {
                labels: disciplines,
                datasets: categories.map(category => {
                    return {
                        label: `Category ${category}`,
                        data: disciplines.map(discipline => {
                            const items = gridData.filter(d => d.discipline === discipline && d.category === category);
                            if (items.length === 0) return 0;
                            const sum = items.reduce((total, item) => {
                                switch(metric) {
                                    case 'Total_Issued': return total + item.issued;
                                    case 'Total_Released': return total + item.released;
                                    case 'Remaining': return total + item.remaining;
                                    default: return total + item.issued;
                                }
                            }, 0);
                            return sum;
                        }),
                        backgroundColor: getCategoryColor(category),
                        stack: 'stack'
                    };
                })
            };
        }
        
        function getDisciplineBarData() {
            let filteredData = gridData;
            
            // Apply subsystem filter if any
            if (activeSubsystems.discipline.length > 0) {
                filteredData = gridData.filter(item => activeSubsystems.discipline.includes(item.discipline));
            }
            
            const disciplines = [...new Set(filteredData.map(item => item.discipline))];
            
            return {
                labels: disciplines,
                datasets: [
                    {
                        label: 'Issued',
                        data: disciplines.map(discipline => 
                            filteredData.filter(item => item.discipline === discipline)
                            .reduce((sum, item) => sum + item.issued, 0)
                        ),
                        backgroundColor: '#3498db'
                    },
                    {
                        label: 'Released',
                        data: disciplines.map(discipline => 
                            filteredData.filter(item => item.discipline === discipline)
                            .reduce((sum, item) => sum + item.released, 0)
                        ),
                        backgroundColor: '#2ecc71'
                    },
                    {
                        label: 'Remaining',
                        data: disciplines.map(discipline => 
                            filteredData.filter(item => item.discipline === discipline)
                            .reduce((sum, item) => sum + item.remaining, 0)
                        ),
                        backgroundColor: '#e74c3c'
                    }
                ]
            };
        }
        
        function getCompletionRateData() {
            let filteredData = gridData;
            
            // Apply subsystem filter if any
            if (activeSubsystems.discipline.length > 0) {
                filteredData = gridData.filter(item => activeSubsystems.discipline.includes(item.discipline));
            }
            
            const disciplines = [...new Set(filteredData.map(item => item.discipline))];
            
            return {
                labels: disciplines,
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: disciplines.map(discipline => {
                        const disciplineData = filteredData.filter(item => item.discipline === discipline);
                        const totalIssued = disciplineData.reduce((sum, item) => sum + item.issued, 0);
                        const totalReleased = disciplineData.reduce((sum, item) => sum + item.released, 0);
                        return totalIssued > 0 ? (totalReleased / totalIssued * 100).toFixed(1) : 0;
                    }),
                    backgroundColor: '#1abc9c'
                }]
            };
        }
        
        function getCategoryBarData() {
            let filteredData = gridData;
            
            // Apply subsystem filter if any
            if (activeSubsystems.category.length > 0) {
                filteredData = gridData.filter(item => activeSubsystems.category.includes(item.category));
            }
            
            const categories = [...new Set(filteredData.map(item => item.category))].sort();
            
            return {
                labels: categories.map(c => `Category ${c}`),
                datasets: [
                    {
                        label: 'Issued',
                        data: categories.map(category => 
                            filteredData.filter(item => item.category === category)
                            .reduce((sum, item) => sum + item.issued, 0)
                        ),
                        backgroundColor: '#3498db'
                    },
                    {
                        label: 'Released',
                        data: categories.map(category => 
                            filteredData.filter(item => item.category === category)
                            .reduce((sum, item) => sum + item.released, 0)
                        ),
                        backgroundColor: '#2ecc71'
                    },
                    {
                        label: 'Remaining',
                        data: categories.map(category => 
                            filteredData.filter(item => item.category === category)
                            .reduce((sum, item) => sum + item.remaining, 0)
                        ),
                        backgroundColor: '#e74c3c'
                    }
                ]
            };
        }
        
        function getRemainingPieData() {
            let filteredData = gridData;
            
            // Apply subsystem filter if any
            if (activeSubsystems.category.length > 0) {
                filteredData = gridData.filter(item => activeSubsystems.category.includes(item.category));
            }
            
            const categories = [...new Set(filteredData.map(item => item.category))].sort();
            
            return {
                labels: categories.map(c => `Category ${c}`),
                datasets: [{
                    data: categories.map(category => 
                        filteredData.filter(item => item.category === category)
                        .reduce((sum, item) => sum + item.remaining, 0)
                    ),
                    backgroundColor: categories.map(c => getCategoryColor(c)),
                    borderWidth: 1
                }]
            };
        }
        
        function getSubsystemBarData(metric) {
            // Group by sub-system
            const subsystemMap = {};
            
            gridData.forEach(item => {
                if (!subsystemMap[item.subSystem]) {
                    subsystemMap[item.subSystem] = {
                        issued: 0,
                        released: 0,
                        remaining: 0
                    };
                }
                
                subsystemMap[item.subSystem].issued += item.issued;
                subsystemMap[item.subSystem].released += item.released;
                subsystemMap[item.subSystem].remaining += item.remaining;
            });
            
            // Convert to array and sort
            let subsystems = Object.entries(subsystemMap).map(([subSystem, data]) => ({
                subSystem,
                ...data
            }));
            
            // Sort based on selected metric
            switch(metric) {
                case 'Total_Issued':
                    subsystems.sort((a, b) => b.issued - a.issued);
                    break;
                case 'Total_Released':
                    subsystems.sort((a, b) => b.released - a.released);
                    break;
                case 'Remaining':
                    subsystems.sort((a, b) => b.remaining - a.remaining);
                    break;
            }
            
            // Take top 15
            subsystems = subsystems.slice(0, 15);
            
            return {
                labels: subsystems.map(item => item.subSystem),
                datasets: [{
                    label: metric === 'Total_Issued' ? 'Issued' : 
                           metric === 'Total_Released' ? 'Released' : 'Remaining',
                    data: subsystems.map(item => 
                        metric === 'Total_Issued' ? item.issued : 
                        metric === 'Total_Released' ? item.released : item.remaining
                    ),
                    backgroundColor: '#3498db'
                }]
            };
        }
        
        function getActivityTrendData(days) {
            const disciplines = [...new Set(gridData.map(item => item.discipline))];
            
            let releasedData, issuedData;
            if (days === 30) {
                releasedData = disciplines.map(discipline => 
                    gridData.filter(item => item.discipline === discipline)
                    .reduce((sum, item) => sum + item.released30, 0)
                );
                issuedData = disciplines.map(discipline => 
                    gridData.filter(item => item.discipline === discipline)
                    .reduce((sum, item) => sum + item.issued30, 0)
                );
            } else if (days === 7) {
                releasedData = disciplines.map(discipline => 
                    gridData.filter(item => item.discipline === discipline)
                    .reduce((sum, item) => sum + item.released7, 0)
                );
                issuedData = disciplines.map(discipline => 
                    gridData.filter(item => item.discipline === discipline)
                    .reduce((sum, item) => sum + item.issued7, 0)
                );
            } else {
                releasedData = disciplines.map(discipline => 
                    gridData.filter(item => item.discipline === discipline)
                    .reduce((sum, item) => sum + item.releasedToday, 0)
                );
                issuedData = disciplines.map(discipline => 
                    gridData.filter(item => item.discipline === discipline)
                    .reduce((sum, item) => sum + item.issuedToday, 0)
                );
            }
            
            return {
                labels: disciplines,
                datasets: [
                    {
                        label: 'Released',
                        data: releasedData,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Issued',
                        data: issuedData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            };
        }
        
        // Chart options functions
        function getPieChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        formatter: (value, ctx) => {
                            const datapoints = ctx.chart.data.datasets[0].data;
                            const total = datapoints.reduce((total, datapoint) => total + datapoint, 0);
                            const percentage = (value / total * 100).toFixed(1);
                            return `${percentage}%`;
                        },
                        color: '#fff',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            };
        }
        
        function getStackedBarOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value.toLocaleString()}`;
                            }
                        }
                    }
                }
            };
        }
        
        function getBarChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value.toLocaleString()}`;
                            }
                        }
                    }
                }
            };
        }
        
        function getPercentageBarOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return `${value}%`;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.raw}%`;
                            }
                        }
                    }
                }
            };
        }
        
        function getLineChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value.toLocaleString()}`;
                            }
                        }
                    }
                }
            };
        }
        
        // Helper function to get color for category
        function getCategoryColor(category) {
            const colors = {
                'A': '#3498db',
                'B': '#2ecc71',
                'C': '#e74c3c',
                'D': '#f39c12',
                'E': '#9b59b6'
            };
            return colors[category] || '#95a5a6';
        }
        
        // Initialize main AG-Grid
        function initMainGrid() {
            const columnDefs = [
                { headerName: "Sub-System", field: "subSystem", sortable: true, filter: true, width: 120 },
                { headerName: "Discipline", field: "discipline", sortable: true, filter: true, width: 100 },
                { headerName: "Category", field: "category", sortable: true, filter: true, width: 100 },
                { headerName: "Issued", field: "issued", sortable: true, filter: true, width: 100 },
                { headerName: "Released", field: "released", sortable: true, filter: true, width: 100 },
                { headerName: "Remaining", field: "remaining", sortable: true, filter: true, width: 120,
                    cellStyle: params => params.value > 0 ? { color: '#e74c3c', fontWeight: 'bold' } : null },
                { headerName: "Released (30d)", field: "released30", sortable: true, filter: true, width: 130 },
                { headerName: "Released (7d)", field: "released7", sortable: true, filter: true, width: 120 },
                { headerName: "Released Today", field: "releasedToday", sortable: true, filter: true, width: 130 },
                { headerName: "Issued (30d)", field: "issued30", sortable: true, filter: true, width: 120 },
                { headerName: "Issued (7d)", field: "issued7", sortable: true, filter: true, width: 110 },
                { headerName: "Issued Today", field: "issuedToday", sortable: true, filter: true, width: 120 },
                { headerName: "Completion %", field: "completionRate", sortable: true, filter: true, width: 130,
                    cellStyle: params => params.value < 50 ? { color: '#e74c3c' } : { color: '#2ecc71' } }
            ];
            
            const gridOptions = {
                columnDefs: columnDefs,
                rowData: gridData,
                defaultColDef: {
                    resizable: true
                },
                pagination: true,
                paginationPageSize: 10,
                domLayout: 'autoHeight',
                onGridReady: function(params) {
                    params.api.sizeColumnsToFit();
                }
            };
            
            new agGrid.Grid(document.getElementById('dataGrid'), gridOptions);
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', function() {
                gridOptions.api.exportDataAsCsv();
            });
            
            // Sub-system toggle
            document.getElementById('showSubsystems').addEventListener('change', function() {
                const subSystemCol = gridOptions.columnApi.getColumn('subSystem');
                gridOptions.columnApi.setColumnVisible(subSystemCol, this.checked);
            });
        }
        
        // Initialize subsystem AG-Grid
        function initSubsystemGrid() {
            // Group by sub-system
            const subsystemMap = {};
            
            gridData.forEach(item => {
                if (!subsystemMap[item.subSystem]) {
                    subsystemMap[item.subSystem] = {
                        issued: 0,
                        released: 0,
                        remaining: 0,
                        releasedToday: 0,
                        released7: 0,
                        released30: 0,
                        issuedToday: 0,
                        issued7: 0,
                        issued30: 0
                    };
                }
                
                subsystemMap[item.subSystem].issued += item.issued;
                subsystemMap[item.subSystem].released += item.released;
                subsystemMap[item.subSystem].remaining += item.remaining;
                subsystemMap[item.subSystem].releasedToday += item.releasedToday;
                subsystemMap[item.subSystem].released7 += item.released7;
                subsystemMap[item.subSystem].released30 += item.released30;
                subsystemMap[item.subSystem].issuedToday += item.issuedToday;
                subsystemMap[item.subSystem].issued7 += item.issued7;
                subsystemMap[item.subSystem].issued30 += item.issued30;
            });
            
            // Convert to array
            const subsystemData = Object.entries(subsystemMap).map(([subSystem, data]) => ({
                subSystem,
                ...data,
                completionRate: (data.released / data.issued * 100).toFixed(1)
            }));
            
            const columnDefs = [
                { headerName: "Sub-System", field: "subSystem", sortable: true, filter: true, width: 120 },
                { headerName: "Issued", field: "issued", sortable: true, filter: true, width: 100 },
                { headerName: "Released", field: "released", sortable: true, filter: true, width: 100 },
                { headerName: "Remaining", field: "remaining", sortable: true, filter: true, width: 120,
                    cellStyle: params => params.value > 0 ? { color: '#e74c3c', fontWeight: 'bold' } : null },
                { headerName: "Released (30d)", field: "released30", sortable: true, filter: true, width: 130 },
                { headerName: "Released (7d)", field: "released7", sortable: true, filter: true, width: 120 },
                { headerName: "Released Today", field: "releasedToday", sortable: true, filter: true, width: 130 },
                { headerName: "Issued (30d)", field: "issued30", sortable: true, filter: true, width: 120 },
                { headerName: "Issued (7d)", field: "issued7", sortable: true, filter: true, width: 110 },
                { headerName: "Issued Today", field: "issuedToday", sortable: true, filter: true, width: 120 },
                { headerName: "Completion %", field: "completionRate", sortable: true, filter: true, width: 130,
                    cellStyle: params => params.value < 50 ? { color: '#e74c3c' } : { color: '#2ecc71' } }
            ];
            
            const gridOptions = {
                columnDefs: columnDefs,
                rowData: subsystemData,
                defaultColDef: {
                    resizable: true
                },
                pagination: true,
                paginationPageSize: 10,
                domLayout: 'autoHeight',
                onGridReady: function(params) {
                    params.api.sizeColumnsToFit();
                }
            };
            
            new agGrid.Grid(document.getElementById('subsystemGrid'), gridOptions);
        }
        
        // Export all data
        document.getElementById('exportAllBtn').addEventListener('click', function() {
            // Create a combined CSV of all data
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add summary
            csvContent += "Summary\n";
            csvContent += `Total Issues,${document.getElementById('totalIssues').textContent}\n`;
            csvContent += `Total Released,${document.getElementById('totalReleased').textContent}\n`;
            csvContent += `Total Remaining,${document.getElementById('totalRemaining').textContent}\n`;
            csvContent += `Issued Last 30 Days,${document.getElementById('recentIssued').textContent}\n\n`;
            
            // Add detailed data
            csvContent += "Detailed Data\n";
            const headers = Object.keys(gridData[0]).join(",");
            csvContent += headers + "\n";
            
            gridData.forEach(item => {
                const row = Object.values(item).join(",");
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "punch_list_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Load data when page is ready
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
