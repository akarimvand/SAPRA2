<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مانیتورینگ گردش اسناد</title>
    <link rel="stylesheet" href="../libs/css/tailwind.min.css">
    <script src="../libs/js/chart.umd.min.js"></script>
    <script src="../libs/js/papaparse.min.js"></script>
    <script src="../libs/js/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="../libs/css/fontawesome.min.css">
    <link rel="stylesheet" href="../libs/fonts/vazir.css">
    <style>
        body { font-family: 'Vazir', sans-serif; }
        .tooltip-custom { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 1000; display: none; }
        .heatmap-cell { cursor: pointer; transition: all 0.2s; }
        .heatmap-cell:hover { opacity: 0.8; transform: scale(1.05); }
        .stat-card { position: relative; transition: all 0.3s; overflow: hidden; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .doughnut-container { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; }
        .doughnut-container canvas { width: 100%; height: 100%; }
        .doughnut-percent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.3rem; font-weight: 800; }
        @keyframes countUp { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .count-animate { animation: countUp 0.6s ease-out; }
        .table-row { transition: all 0.2s; border-right: 3px solid transparent; }
        .table-row:hover { transform: translateX(-4px); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .table-row.delay-high { border-right-color: #ef4444; }
        .table-row.delay-medium { border-right-color: #f59e0b; }
        .table-row.delay-low { border-right-color: #10b981; }
        @keyframes rotate-clock { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .rotating-clock { animation: rotate-clock 3s linear infinite; display: inline-block; }
        @media print {
            .no-print { display: none !important; }
            @page { size: A4; margin: 15mm; counter-increment: page; }
            body { margin: 0; padding: 0; counter-reset: page; }
            body > * { display: none !important; }
            #criticalListModal, #fullReportModal { display: block !important; position: static !important; background: white; width: 100%; height: auto; overflow: visible; }
            #criticalListModal > div, #fullReportModal > div { max-height: none !important; overflow: visible !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
            #printableContent, #printableFullReport { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .print-header { display: table !important; width: 100% !important; table-layout: fixed !important; border-collapse: collapse !important; position: running(header); }
            .print-header > div { display: table-cell !important; vertical-align: middle !important; }
            .print-header img { display: block !important; margin: 0 auto !important; }
            .step-section { page-break-inside: avoid; }
            thead { display: table-header-group; }
            img { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .page-number::after { content: counter(page); }
        }
    </style>
</head>
<body class="bg-gray-50" style="visibility:hidden;">
    <div class="tooltip-custom" id="tooltip"></div>
    
    <div id="timelineModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;" onclick="if(event.target===this) closeTimelineModal()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modalTitle"></h3>
                <button onclick="closeTimelineModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="timelineContent"></div>
        </div>
    </div>

    <div id="criticalListModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;" onclick="if(event.target===this) closeCriticalListModal()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 no-print">
                <h3 class="text-xl font-bold">لیست کامل ساب سیستمهای بحرانی</h3>
                <div class="flex gap-2">
                    <button onclick="printCriticalList()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-print"></i> چاپ
                    </button>
                    <button onclick="closeCriticalListModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
            </div>
            <div id="criticalListContent"></div>
        </div>
    </div>

    <div id="fullReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;" onclick="if(event.target===this) closeFullReportModal()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 no-print">
                <h3 class="text-xl font-bold">گزارش کامل وضعیت ساب سیستمها</h3>
                <div class="flex gap-2">
                    <button onclick="printFullReport()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-print"></i> چاپ
                    </button>
                    <button onclick="closeFullReportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
            </div>
            <div id="fullReportContent"></div>
        </div>
    </div>
    
    <div class="container mx-auto p-4">
        <div class="bg-white rounded shadow-sm p-2 mb-4 flex justify-end gap-2 no-print">
            <button onclick="resetFilters()" class="bg-gray-500 text-white px-3 py-1.5 rounded hover:bg-gray-600 text-xs">
                <i class="fas fa-redo"></i> پاک کردن فیلترها
            </button>
            <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs">
                <i class="fas fa-file-excel"></i> خروجی Excel
            </button>
            <button onclick="showCriticalListModal()" class="bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700 text-xs relative">
                <i class="fas fa-exclamation-triangle"></i> گزارش بحرانی
                <span id="criticalCountBadge" class="absolute -top-1 -right-1 bg-yellow-400 text-red-900 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center" style="animation: pulse 2s ease-in-out infinite;">0</span>
            </button>
            <button onclick="showFullReport()" class="bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 text-xs">
                <i class="fas fa-file-alt"></i> گزارش کامل
            </button>
        </div>

        <section class="mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-chart-line"></i> نمای کلی</h2>
            <div class="overflow-x-auto md:overflow-visible" style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;">
                <div class="grid gap-4" id="globalStats"></div>
            </div>
        </section>

        <section class="bg-white rounded-lg shadow-md mb-6 no-print">
            <div class="flex justify-between items-center p-4 cursor-pointer" onclick="toggleFilters()">
                <h2 class="text-lg font-bold text-gray-800"><i class="fas fa-filter"></i> فیلترها</h2>
                <i id="filterToggleIcon" class="fas fa-chevron-down text-gray-600"></i>
            </div>
            <div id="filterContent" style="display: none;" class="p-4 pt-0">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">مرحله</label>
                        <select id="filterStep" class="w-full border rounded px-3 py-2">
                            <option value="">همه مراحل</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">واحد</label>
                        <select id="filterUnit" class="w-full border rounded px-3 py-2">
                            <option value="">همه واحدها</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">زیرسیستم</label>
                        <input type="text" id="filterSubSystem" placeholder="جستجو..." class="w-full border rounded px-3 py-2">
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilters()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-filter"></i> اعمال
                        </button>
                    </div>
                </div>
                <div id="activeFilters" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
        </section>



        <section class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6" id="heatmapSection">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-3">
                <h2 class="text-lg md:text-xl font-bold text-gray-800"><i class="fas fa-th"></i> ماتریس وضعیت مراحل</h2>
                <div class="flex flex-wrap gap-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background: #d1fae5;"></span> عالی</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background: #dbeafe;"></span> خوب</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background: #fef3c7;"></span> هشدار</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background: #fee2e2;"></span> بحرانی</span>
                </div>
            </div>
            <div id="heatmap" class="overflow-x-auto -mx-4 md:mx-0 px-4 md:px-0"></div>
        </section>



        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-table"></i> وضعیت صف فعلی</h2>
                <button onclick="exportQueueToExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm no-print">
                    <i class="fas fa-file-excel"></i> خروجی Excel
                </button>
            </div>
            <div id="miniHeatmap" class="mb-4"></div>
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3 no-print">
                <input type="text" id="tableFilterSubSystem" placeholder="فیلتر بر اساس زیرسیستم..." class="border rounded px-3 py-2 text-sm" oninput="filterQueueTable()">
                <input type="text" id="tableFilterUnit" placeholder="فیلتر بر اساس واحد..." class="border rounded px-3 py-2 text-sm" oninput="filterQueueTable()">
                <input type="text" id="tableFilterPerson" placeholder="فیلتر بر اساس شخص..." class="border rounded px-3 py-2 text-sm" oninput="filterQueueTable()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="queueTable">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-center">#</th>
                            <th class="p-2 text-left cursor-pointer" onclick="sortTable('Sub_System')">زیرسیستم <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" onclick="sortTable('STEP')">مرحله <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" onclick="sortTable('UNIT')">واحد <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left">شخص</th>
                            <th class="p-2 text-left">توضیحات</th>
                            <th class="p-2 text-left cursor-pointer" onclick="sortTable('RECEIVED_DATE')">تاریخ دریافت <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" onclick="sortTable('daysInStage')">روز <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" onclick="sortTable('loops')">تعداد مراحل <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-center">جزئیات</th>
                        </tr>
                    </thead>
                    <tbody id="queueTableBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        let allData = [], filteredData = [], documentPaths = new Map();
        const STEPS_ORDER = ['Execution Activities', 'FORM A', 'FORM B', 'FORM C', 'FORM D'];
        const DELAY_THRESHOLD = 7;

        async function loadData() {
            const loadingEl = document.createElement('div');
            loadingEl.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;"><i class="fas fa-spinner fa-spin" style="font-size:24px;color:#3b82f6;"></i><div style="margin-top:10px;font-weight:bold;">در حال بارگذاری...</div></div>';
            document.body.appendChild(loadingEl);
            try {
                const response = await fetch('../dbcsv/HOS_WORK_FLOW.csv', { cache: 'force-cache' });
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: false });
                
                allData = parsed.data.filter(row => row.Sub_System && row.STEP && row.UNIT && row.RECEIVED_DATE).map(row => ({
                    ID: parseInt(row.ID) || 0, Sub_System: row.Sub_System.trim(), STEP: row.STEP.trim(), UNIT: row.UNIT.trim(),
                    PERSON: row.PERSON?.trim() || '', DESCRIPTION: row.DESCRIPTION?.trim() || '', RECEIVED_DATE: new Date(row.RECEIVED_DATE)
                })).filter(item => !isNaN(item.RECEIVED_DATE.getTime())).sort((a, b) => a.ID - b.ID);

                processDocumentPaths();
                filteredData = [...allData];
                populateFilters();
                setTimeout(() => { 
                    renderAll(); 
                    loadingEl.remove(); 
                    document.body.style.visibility = 'visible';
                }, 100);
            } catch (error) {
                loadingEl.remove();
                console.error('Error:', error);
                alert('خطا در بارگذاری داده');
            }
        }

        function processDocumentPaths() {
            documentPaths.clear();
            const grouped = new Map();
            for (const record of allData) {
                if (!grouped.has(record.Sub_System)) grouped.set(record.Sub_System, []);
                grouped.get(record.Sub_System).push(record);
            }
            for (const [subSystem, records] of grouped) {
                records.sort((a, b) => a.RECEIVED_DATE - b.RECEIVED_DATE || a.ID - b.ID);
                const lastRecord = records[records.length - 1];
                documentPaths.set(subSystem, {
                    subSystem, records, currentStep: lastRecord.STEP, currentUnit: lastRecord.UNIT,
                    loops: calculateLoops(records), delays: calculateDelays(records)
                });
            }
        }

        function calculateLoops(records) {
            const unitVisits = new Map();
            let loops = 0;
            for (const record of records) {
                const key = `${record.STEP}-${record.UNIT}`;
                const count = (unitVisits.get(key) || 0) + 1;
                unitVisits.set(key, count);
                if (count > 1) loops++;
            }
            return loops;
        }

        function calculateDelays(records) {
            let delays = 0;
            for (let i = 0; i < records.length - 1; i++) {
                const days = Math.ceil((records[i + 1].RECEIVED_DATE - records[i].RECEIVED_DATE) / 86400000);
                if (days > DELAY_THRESHOLD) delays++;
            }
            return delays;
        }

        function populateFilters() {
            const steps = [...new Set(allData.map(d => d.STEP))].sort();
            const units = [...new Set(allData.map(d => d.UNIT))].sort();
            steps.forEach(step => {
                const option = document.createElement('option');
                option.value = step;
                option.textContent = step;
                document.getElementById('filterStep').appendChild(option);
            });
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                document.getElementById('filterUnit').appendChild(option);
            });
        }

        function applyFilters() {
            const step = document.getElementById('filterStep').value;
            const unit = document.getElementById('filterUnit').value;
            const subSystem = document.getElementById('filterSubSystem').value.toLowerCase();
            filteredData = allData.filter(record => {
                if (step && record.STEP !== step) return false;
                if (unit && record.UNIT !== unit) return false;
                if (subSystem && !record.Sub_System.toLowerCase().includes(subSystem)) return false;
                return true;
            });
            updateActiveFilters();
            renderAll();
        }

        function resetFilters() {
            document.getElementById('filterStep').value = '';
            document.getElementById('filterUnit').value = '';
            document.getElementById('filterSubSystem').value = '';
            filteredData = [...allData];
            updateActiveFilters();
            renderAll();
        }

        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            const step = document.getElementById('filterStep').value;
            const unit = document.getElementById('filterUnit').value;
            const subSystem = document.getElementById('filterSubSystem').value;
            let html = '';
            if (step) html += '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs">مرحله: ' + step + ' <i class="fas fa-times cursor-pointer ml-1" onclick="removeFilter(\'step\')"></i></span>';
            if (unit) html += '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">واحد: ' + unit + ' <i class="fas fa-times cursor-pointer ml-1" onclick="removeFilter(\'unit\')"></i></span>';
            if (subSystem) html += '<span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs">زیرسیستم: ' + subSystem + ' <i class="fas fa-times cursor-pointer ml-1" onclick="removeFilter(\'subsystem\')"></i></span>';
            container.innerHTML = html;
        }

        function removeFilter(type) {
            if (type === 'step') document.getElementById('filterStep').value = '';
            if (type === 'unit') document.getElementById('filterUnit').value = '';
            if (type === 'subsystem') document.getElementById('filterSubSystem').value = '';
            applyFilters();
        }

        function renderAll() {
            requestAnimationFrame(() => {
                renderCriticalAlerts();
                renderGlobalStats();
                requestAnimationFrame(() => {
                    renderHeatmap();
                    renderMiniHeatmap();
                    renderQueueTable();
                });
            });
        }

        let criticalDocuments = [];

        function renderCriticalAlerts() {
            criticalDocuments = [];
            documentPaths.forEach((path, subSystem) => {
                const lastRecord = path.records[path.records.length - 1];
                const daysInStage = Math.ceil((new Date() - lastRecord.RECEIVED_DATE) / 86400000);
                if (daysInStage > 14) {
                    criticalDocuments.push({ subSystem, daysInStage, step: lastRecord.STEP, unit: lastRecord.UNIT, person: lastRecord.PERSON, date: lastRecord.RECEIVED_DATE });
                }
            });
            criticalDocuments.sort((a, b) => b.daysInStage - a.daysInStage);
            const badge = document.getElementById('criticalCountBadge');
            if (badge) badge.textContent = criticalDocuments.length;
        }

        function printCriticalDocuments() {
            const printWindow = window.open('', '_blank');
            let html = '<html dir="rtl"><head><meta charset="UTF-8"><title>لیست اسناد بحرانی</title>';
            html += '<style>body{font-family:Tahoma,Arial;padding:20px;}table{width:100%;border-collapse:collapse;margin-top:20px;}th,td{border:1px solid #ddd;padding:8px;text-align:right;}th{background:#ef4444;color:white;}tr:nth-child(even){background:#fee2e2;}.header{text-align:center;margin-bottom:20px;}.header h1{color:#ef4444;margin:0;}.header p{color:#666;margin:5px 0;}</style></head><body>';
            html += '<div class="header"><h1>لیست اسناد بحرانی با تاخیر بالا</h1><p>تعداد: ' + criticalDocuments.length + ' سند | تاریخ: ' + new Date().toLocaleDateString('fa-IR') + '</p></div>';
            html += '<table><thead><tr><th>#</th><th>زیرسیستم</th><th>مرحله</th><th>واحد</th><th>شخص</th><th>تاریخ دریافت</th><th>تعداد روز تاخیر</th></tr></thead><tbody>';
            criticalDocuments.forEach((item, idx) => {
                html += '<tr><td>' + (idx + 1) + '</td><td>' + item.subSystem + '</td><td>' + item.step + '</td><td>' + item.unit + '</td><td>' + item.person + '</td><td>' + item.date.toLocaleDateString('fa-IR') + '</td><td style="color:#ef4444;font-weight:bold;">' + item.daysInStage + ' روز</td></tr>';
            });
            html += '</tbody></table></body></html>';
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 250);
        }

        function renderGlobalStats() {
            const stats = { 'Execution Activities': 0, 'FORM A': 0, 'FORM B': 0, 'FORM C': 0, 'FORM D': 0 };
            documentPaths.forEach(path => { if (stats.hasOwnProperty(path.currentStep)) stats[path.currentStep]++; });
            const total = stats['Execution Activities'] + stats['FORM A'] + stats['FORM B'] + stats['FORM C'] + stats['FORM D'];
            const container = document.getElementById('globalStats');
            container.className = 'flex md:grid gap-4 md:grid-cols-' + STEPS_ORDER.length;
            container.innerHTML = '';
            const colors = { 'Execution Activities': '#64748b', 'FORM A': '#3b82f6', 'FORM B': '#10b981', 'FORM C': '#f59e0b', 'FORM D': '#ef4444' };
            const bgColors = { 'Execution Activities': '#64748b', 'FORM A': '#3b82f6', 'FORM B': '#10b981', 'FORM C': '#f59e0b', 'FORM D': '#ef4444' };
            STEPS_ORDER.forEach((step, idx) => {
                const count = stats[step] || 0;
                const percentage = total > 0 ? Math.ceil((count / total) * 1000) / 10 : 0;
                const cardId = 'card-' + idx;
                const canvasId = 'canvas-' + idx;
                let description = '';
                if (step === 'Execution Activities') {
                    description = 'تعداد ساب سیستمی که در حال تکمیل فعالیتهای اجرایی جهت ارسال فرم A میباشد';
                } else {
                    const formName = step.replace('FORM ', '');
                    description = 'تعداد ساب سیستمی که در حال حاضر در مرحله فرم "' + formName + '" میباشد';
                }
                container.innerHTML += '<div id="' + cardId + '" class="stat-card bg-white rounded-xl shadow-md cursor-pointer flex-shrink-0 w-full md:w-auto" onclick="filterByStep(\'' + step + '\')" style="font-family: Vazir, sans-serif; scroll-snap-align: start;"><div style="background: ' + bgColors[step] + '; color: white; padding: 12px 16px; font-size: 0.85rem; font-weight: 700; text-align: center; border-radius: 12px 12px 0 0;">' + step + '</div><div style="padding: 24px 16px; display: flex; align-items: center; gap: 16px;"><div style="flex: 1; text-align: right;"><div class="count-animate" style="font-size: 3.5rem; font-weight: 900; color: ' + bgColors[step] + '; line-height: 1;">' + count + '</div><div style="font-size: 0.75rem; color: #64748b; margin-top: 12px; font-weight: 600; text-align: right;">' + description + '</div></div><div class="doughnut-container" style="flex-shrink: 0;"><canvas id="' + canvasId + '" width="100" height="100"></canvas><div class="doughnut-percent" style="color: ' + bgColors[step] + ';">' + percentage + '%</div></div></div></div>';
            });
            setTimeout(() => {
                STEPS_ORDER.forEach((step, idx) => {
                    const count = stats[step] || 0;
                    const percentage = step !== 'Execution Activities' && total > 0 ? (count / total) * 100 : 0;
                    const canvas = document.getElementById('canvas-' + idx);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: { datasets: [{ data: [percentage, 100 - percentage], backgroundColor: [colors[step], '#e2e8f0'], borderWidth: 0 }] },
                            options: { responsive: false, cutout: '65%', plugins: { legend: { display: false }, tooltip: { enabled: false } }, animation: { animateRotate: true, duration: 1200 } }
                        });
                    }
                });
            }, 100);
        }

        function filterByStep(step) {
            document.getElementById('filterStep').value = step;
            applyFilters();
        }

        function renderHeatmap() {
            const step = document.getElementById('filterStep').value;
            const unit = document.getElementById('filterUnit').value;
            const heatmapSection = document.getElementById('heatmapSection');
            if (step || unit) {
                heatmapSection.style.display = 'none';
                return;
            }
            heatmapSection.style.display = 'block';
            const heatmapData = new Map(), currentInStage = new Map(), currentDaysData = new Map(), groupedAll = new Map();
            for (const record of allData) {
                if (!groupedAll.has(record.Sub_System)) groupedAll.set(record.Sub_System, []);
                groupedAll.get(record.Sub_System).push(record);
            }
            const now = new Date();
            for (const [subSystem, records] of groupedAll) {
                records.sort((a, b) => a.RECEIVED_DATE - b.RECEIVED_DATE || a.ID - b.ID);
                const subsystemStayDays = new Map();
                for (let i = 0; i < records.length; i++) {
                    const record = records[i];
                    const key = `${record.STEP}|${record.UNIT}`;
                    if (!heatmapData.has(key)) heatmapData.set(key, { subsystems: new Set(), totalDays: 0 });
                    heatmapData.get(key).subsystems.add(record.Sub_System);
                    const days = i < records.length - 1 ? Math.ceil((records[i + 1].RECEIVED_DATE - record.RECEIVED_DATE) / 86400000) : Math.ceil((now - record.RECEIVED_DATE) / 86400000);
                    subsystemStayDays.set(key, (subsystemStayDays.get(key) || 0) + days);
                }
                for (const [key, days] of subsystemStayDays) {
                    heatmapData.get(key).totalDays += days;
                }
            }
            const filteredSubSystems = new Set(filteredData.map(d => d.Sub_System));
            for (const [subSystem, path] of documentPaths) {
                if (!filteredSubSystems.has(subSystem)) continue;
                const lastRecord = path.records[path.records.length - 1];
                const key = `${lastRecord.STEP}|${lastRecord.UNIT}`;
                let daysInCurrent = 0;
                for (let i = path.records.length - 1; i >= 0; i--) {
                    if (path.records[i].STEP === lastRecord.STEP && path.records[i].UNIT === lastRecord.UNIT) {
                        daysInCurrent = i < path.records.length - 1 ? Math.ceil((path.records[i + 1].RECEIVED_DATE - path.records[i].RECEIVED_DATE) / 86400000) : Math.ceil((now - path.records[i].RECEIVED_DATE) / 86400000);
                        break;
                    }
                }
                currentInStage.set(key, (currentInStage.get(key) || 0) + 1);
                if (!currentDaysData.has(key)) currentDaysData.set(key, { count: 0, totalDays: 0 });
                const data = currentDaysData.get(key);
                data.count++;
                data.totalDays += daysInCurrent;
            }
            const steps = [...new Set(filteredData.filter(d => d.STEP !== 'Execution Activities').map(d => d.STEP))].sort();
            const unitsOrder = ['CONTRACTOR', 'PRECOM', 'TPA', 'OWNER'];
            const units = unitsOrder.filter(u => filteredData.some(d => d.UNIT === u && d.STEP !== 'Execution Activities'));
            for (const [key, data] of heatmapData) { 
                const [step, unit] = key.split('|');
                data.count = allData.filter(r => r.STEP === step && r.UNIT === unit).length;
                data.avgAllDays = data.count > 0 ? Math.round(data.totalDays / data.subsystems.size) : 0;
                const currentData = currentDaysData.get(key);
                data.avgCurrentDays = currentData ? Math.round(currentData.totalDays / currentData.count) : 0;
            }
            let html = '<table class="w-full border-collapse" style="font-family: Vazir, sans-serif;"><thead><tr><th class="p-2 bg-gradient-to-b from-slate-700 to-slate-600 font-bold text-xs text-white border border-slate-500">مرحله / واحد</th>';
            units.forEach(unit => html += '<th class="p-2 bg-gradient-to-b from-slate-700 to-slate-600 font-bold text-xs text-white border border-slate-500">' + unit + '</th>');
            html += '</tr></thead><tbody>';
            steps.forEach(step => {
                html += '<tr><td class="p-2 font-bold bg-slate-50 text-xs text-slate-800 border border-gray-300">' + step + '</td>';
                units.forEach(unit => {
                    const key = `${step}|${unit}`;
                    const data = heatmapData.get(key);
                    const current = currentInStage.get(key) || 0;
                    if (data) {
                        const avgAllDays = data.avgAllDays;
                        let bgColor, borderColor, textColor, icon;
                        if (avgAllDays > 14) { bgColor = '#fee2e2'; borderColor = '#ef4444'; textColor = '#991b1b'; icon = 'fa-exclamation-triangle'; }
                        else if (avgAllDays > 7) { bgColor = '#fef3c7'; borderColor = '#f59e0b'; textColor = '#92400e'; icon = 'fa-clock'; }
                        else if (avgAllDays > 3) { bgColor = '#dbeafe'; borderColor = '#3b82f6'; textColor = '#1e40af'; icon = 'fa-info-circle'; }
                        else { bgColor = '#d1fae5'; borderColor = '#10b981'; textColor = '#065f46'; icon = 'fa-check-circle'; }
                        html += '<td class="border border-gray-300 p-0"><div class="heatmap-cell p-2 cursor-pointer" style="background: ' + bgColor + '; border-left: 3px solid ' + borderColor + '; min-height: 80px; display: flex; flex-direction: column; justify-content: space-between;" onclick="filterByStepUnit(\'' + step + '\', \'' + unit + '\')">' +
                        '<div class="flex flex-col items-end"><div style="font-size: 8px; color: ' + textColor + '; margin-bottom: 1px;">در حال حاضر</div><div style="font-size: 2.5rem; font-weight: 900; line-height: 1; color: ' + borderColor + ';">' + current + '</div></div>' +
                        '<div style="margin-top: auto;"><div style="font-size: 10px; margin-bottom: 2px; color: ' + textColor + ';"><span>عبور: </span><strong>' + data.count + '</strong></div>' +
                        '<div style="font-size: 10px; margin-bottom: 2px; font-weight: bold; color: ' + borderColor + ';"><span>میانگین کل: </span><span>' + avgAllDays + ' روز</span></div>' +
                        (data.avgCurrentDays > 0 ? '<div style="font-size: 10px; font-weight: bold; color: ' + borderColor + ';"><span>میانگین فعلی: </span><span>' + data.avgCurrentDays + ' روز</span></div>' : '') +
                        '</div></div></td>';
                    } else {
                        html += '<td class="border border-gray-300 p-1 bg-gray-100"></td>';
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('heatmap').innerHTML = html;
        }

        function filterByStepUnit(step, unit) {
            document.getElementById('filterStep').value = step;
            document.getElementById('filterUnit').value = unit;
            applyFilters();
        }



        function renderMiniHeatmap() {
            const step = document.getElementById('filterStep').value;
            const unit = document.getElementById('filterUnit').value;
            if (!step || !unit) {
                document.getElementById('miniHeatmap').innerHTML = '';
                return;
            }
            const subsystemDays = {};
            const groupedAll = {};
            allData.forEach(record => {
                if (!groupedAll[record.Sub_System]) groupedAll[record.Sub_System] = [];
                groupedAll[record.Sub_System].push(record);
            });
            Object.entries(groupedAll).forEach(([subSystem, records]) => {
                records.sort((a, b) => a.RECEIVED_DATE - b.RECEIVED_DATE || a.ID - b.ID);
                let totalDays = 0;
                for (let i = 0; i < records.length; i++) {
                    if (records[i].STEP === step && records[i].UNIT === unit) {
                        const days = i < records.length - 1 ? Math.ceil((records[i + 1].RECEIVED_DATE - records[i].RECEIVED_DATE) / 86400000) : Math.ceil((new Date() - records[i].RECEIVED_DATE) / 86400000);
                        totalDays += days;
                    }
                }
                if (totalDays > 0) subsystemDays[subSystem] = totalDays;
            });
            if (Object.keys(subsystemDays).length === 0) {
                document.getElementById('miniHeatmap').innerHTML = '';
                return;
            }
            const currentSubsystems = new Set();
            documentPaths.forEach((path, subSystem) => {
                const lastRecord = path.records[path.records.length - 1];
                if (lastRecord.STEP === step && lastRecord.UNIT === unit) {
                    currentSubsystems.add(subSystem);
                }
            });
            const totalDays = Object.values(subsystemDays).reduce((sum, days) => sum + days, 0);
            const avgAll = Math.round(totalDays / Object.keys(subsystemDays).length);
            const currentDays = Array.from(currentSubsystems).map(sub => subsystemDays[sub] || 0).reduce((sum, days) => sum + days, 0);
            const avgCurrent = currentSubsystems.size > 0 ? Math.round(currentDays / currentSubsystems.size) : 0;
            const maxDays = Math.max(...Object.values(subsystemDays));
            let html = '<div class="bg-white rounded-xl shadow-md p-4 border-2 border-blue-200"><h3 class="text-sm font-bold text-slate-800 flex items-center gap-2 mb-2"><i class="fas fa-chart-bar text-blue-600"></i>توزیع روزها بر اساس زیرسیستم (' + step + ' / ' + unit + ')</h3><div class="flex gap-4 text-xs mb-3"><span class="font-semibold text-slate-700">میانگین کل: <strong class="text-blue-600">' + avgAll + ' روز</strong></span>' + (avgCurrent > 0 ? '<span class="font-semibold text-slate-700">میانگین فعلی: <strong class="text-orange-600">' + avgCurrent + ' روز</strong></span>' : '') + '</div><div class="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-2">';
            Object.entries(subsystemDays).sort((a, b) => b[1] - a[1]).forEach(([sub, days]) => {
                let bgColor, textColor, iconColor;
                if (days > 14) { bgColor = '#fee2e2'; textColor = '#991b1b'; iconColor = '#ef4444'; }
                else if (days > 7) { bgColor = '#fef3c7'; textColor = '#92400e'; iconColor = '#f59e0b'; }
                else if (days > 3) { bgColor = '#dbeafe'; textColor = '#1e40af'; iconColor = '#3b82f6'; }
                else { bgColor = '#d1fae5'; textColor = '#065f46'; iconColor = '#10b981'; }
                const isCurrent = currentSubsystems.has(sub);
                const icon = isCurrent ? '<i class="fas fa-clock rotating-clock"></i>' : '<i class="fas fa-check-circle"></i>';
                const borderStyle = isCurrent ? 'border-2 border-blue-600' : 'border border-gray-300';
                const statusText = isCurrent ? 'جاری' : 'تکمیل';
                html += '<div class="rounded-lg overflow-hidden transition-all hover:scale-105 hover:shadow-md cursor-pointer ' + borderStyle + '" style="background-color: ' + bgColor + ';" onclick="showTimeline(\'' + sub.replace(/'/g, "\\'") + '\')" ><div class="text-xs font-bold text-center py-1 px-2 truncate" style="background: ' + iconColor + '; color: white;" title="' + sub + '">' + sub + '</div><div class="p-2"><div class="flex items-center justify-between mb-1"><span class="text-xs" style="color: ' + textColor + ';">روز:</span><span class="text-lg font-black" style="color: ' + iconColor + ';">' + days + '</span></div><div class="flex items-center justify-between text-xs"><span class="font-semibold" style="color: ' + textColor + ';">' + statusText + '</span><span style="color: ' + iconColor + ';">' + icon + '</span></div></div></div>';
            });
            html += '</div></div>';
            document.getElementById('miniHeatmap').innerHTML = html;
        }

        let queueTableData = [];
        function renderQueueTable() {
            queueTableData = [];
            const filteredSubSystems = new Set(filteredData.map(d => d.Sub_System));
            const step = document.getElementById('filterStep').value;
            const unit = document.getElementById('filterUnit').value;
            let title = 'وضعیت صف فعلی';
            if (step && unit) {
                title = 'ساب سیستمهایی که در حال حاضر در مرحله ' + step + ' / ' + unit + ' میباشند';
            } else if (step) {
                title = 'ساب سیستمهایی که در حال حاضر در مرحله ' + step + ' میباشند';
            } else if (unit) {
                title = 'ساب سیستمهایی که در حال حاضر در واحد ' + unit + ' میباشند';
            }
            document.querySelector('#queueTable').closest('section').querySelector('h2').innerHTML = '<i class="fas fa-table text-blue-600"></i> ' + title;
            documentPaths.forEach((path, subSystem) => {
                if (!filteredSubSystems.has(subSystem)) return;
                const lastRecord = path.records[path.records.length - 1];
                if (step && lastRecord.STEP !== step) return;
                if (unit && lastRecord.UNIT !== unit) return;
                const daysInStage = Math.ceil((new Date() - lastRecord.RECEIVED_DATE) / 86400000);
                const statusClass = daysInStage > DELAY_THRESHOLD ? 'delay-high' : daysInStage > 3 ? 'delay-medium' : 'delay-low';
                queueTableData.push({ ...lastRecord, daysInStage, loops: path.loops, statusClass });
            });
            queueTableData.sort((a, b) => a.Sub_System.localeCompare(b.Sub_System));
            filterQueueTable();
        }

        function filterQueueTable() {
            const subSystemFilter = document.getElementById('tableFilterSubSystem')?.value.toLowerCase() || '';
            const unitFilter = document.getElementById('tableFilterUnit')?.value.toLowerCase() || '';
            const personFilter = document.getElementById('tableFilterPerson')?.value.toLowerCase() || '';
            const filtered = queueTableData.filter(record => {
                if (subSystemFilter && !record.Sub_System.toLowerCase().includes(subSystemFilter)) return false;
                if (unitFilter && !record.UNIT.toLowerCase().includes(unitFilter)) return false;
                if (personFilter && !record.PERSON.toLowerCase().includes(personFilter)) return false;
                return true;
            });
            const tbody = document.getElementById('queueTableBody');
            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">رکوردی یافت نشد</td></tr>';
                return;
            }
            filtered.forEach((record, index) => {
                const row = document.createElement('tr');
                row.className = 'table-row ' + record.statusClass;
                let daysBadge = '';
                if (record.daysInStage > DELAY_THRESHOLD) {
                    daysBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 bg-red-100 text-red-700 rounded-full font-bold text-sm"><i class="fas fa-exclamation-circle"></i>' + record.daysInStage + '</span>';
                } else if (record.daysInStage > 3) {
                    daysBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 bg-orange-100 text-orange-700 rounded-full font-bold text-sm"><i class="fas fa-clock"></i>' + record.daysInStage + '</span>';
                } else {
                    daysBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full font-bold text-sm"><i class="fas fa-check-circle"></i>' + record.daysInStage + '</span>';
                }
                const btn = document.createElement('button');
                btn.className = 'bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600';
                btn.innerHTML = '<i class="fas fa-eye"></i>';
                btn.onclick = () => showTimeline(record.Sub_System);
                row.innerHTML = '<td class="p-3 border-b border-gray-200 text-center text-gray-600 font-medium">' + (index + 1) + '</td><td class="p-3 border-b border-gray-200 text-slate-800 font-bold">' + record.Sub_System + '</td><td class="p-3 border-b border-gray-200 text-gray-700">' + record.STEP + '</td><td class="p-3 border-b border-gray-200 text-gray-700 font-medium">' + record.UNIT + '</td><td class="p-3 border-b border-gray-200 text-gray-600">' + record.PERSON + '</td><td class="p-3 border-b border-gray-200 text-xs text-gray-500">' + record.DESCRIPTION + '</td><td class="p-3 border-b border-gray-200 text-gray-600">' + record.RECEIVED_DATE.toLocaleDateString('fa-IR') + '</td><td class="p-3 border-b border-gray-200">' + daysBadge + '</td><td class="p-3 border-b border-gray-200 text-center"><span class="inline-flex items-center justify-center w-7 h-7 bg-gray-100 text-gray-700 rounded-full font-bold text-xs">' + record.loops + '</span></td><td class="p-3 border-b border-gray-200 text-center"></td>';
                row.lastElementChild.appendChild(btn);
                tbody.appendChild(row);
            });
        }

        let sortDirection = {};
        function sortTable(column) {
            sortDirection[column] = !sortDirection[column];
            queueTableData.sort((a, b) => {
                let aVal, bVal;
                if (column === 'daysInStage' || column === 'loops') {
                    aVal = a[column]; bVal = b[column];
                    return sortDirection[column] ? aVal - bVal : bVal - aVal;
                } else if (column === 'RECEIVED_DATE') {
                    aVal = a.RECEIVED_DATE.getTime(); bVal = b.RECEIVED_DATE.getTime();
                    return sortDirection[column] ? aVal - bVal : bVal - aVal;
                } else {
                    aVal = a[column] || ''; bVal = b[column] || '';
                    return sortDirection[column] ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
            });
            filterQueueTable();
        }

        function exportQueueToExcel() {
            const subSystemFilter = document.getElementById('tableFilterSubSystem')?.value.toLowerCase() || '';
            const unitFilter = document.getElementById('tableFilterUnit')?.value.toLowerCase() || '';
            const personFilter = document.getElementById('tableFilterPerson')?.value.toLowerCase() || '';
            const filtered = queueTableData.filter(record => {
                if (subSystemFilter && !record.Sub_System.toLowerCase().includes(subSystemFilter)) return false;
                if (unitFilter && !record.UNIT.toLowerCase().includes(unitFilter)) return false;
                if (personFilter && !record.PERSON.toLowerCase().includes(personFilter)) return false;
                return true;
            });
            const wb = XLSX.utils.book_new();
            const wsData = [['ردیف', 'زیرسیستم', 'مرحله', 'واحد', 'مسئول', 'توضیحات', 'تاریخ دریافت', 'روز', 'حلقه']];
            filtered.forEach((record, index) => {
                wsData.push([index + 1, record.Sub_System, record.STEP, record.UNIT, record.PERSON, record.DESCRIPTION, record.RECEIVED_DATE.toLocaleDateString('fa-IR'), record.daysInStage, record.loops]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'صف فعلی');
            XLSX.writeFile(wb, 'وضعیت_صف_فعلی.xlsx');
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [['ردیف', 'زیرسیستم', 'مرحله', 'واحد', 'مسئول', 'توضیحات', 'تاریخ دریافت', 'روز', 'حلقه']];
            queueTableData.forEach((record, index) => {
                wsData.push([index + 1, record.Sub_System, record.STEP, record.UNIT, record.PERSON, record.DESCRIPTION, record.RECEIVED_DATE.toLocaleDateString('fa-IR'), record.daysInStage, record.loops]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'گزارش');
            XLSX.writeFile(wb, 'گزارش_گردش_اسناد.xlsx');
        }

        function showTimeline(subSystem) {
            const path = documentPaths.get(subSystem);
            if (!path) return;
            document.getElementById('modalTitle').textContent = 'تایم لاین: ' + subSystem;
            let html = '<div class="space-y-3">';
            path.records.forEach((record, idx) => {
                const days = idx < path.records.length - 1 ? Math.ceil((path.records[idx + 1].RECEIVED_DATE - record.RECEIVED_DATE) / 86400000) : Math.ceil((new Date() - record.RECEIVED_DATE) / 86400000);
                const color = days > 14 ? 'red' : days > 7 ? 'yellow' : days > 3 ? 'blue' : 'green';
                html += '<div class="flex items-start gap-3 p-3 bg-' + color + '-50 border-r-4 border-' + color + '-500 rounded"><div class="flex-shrink-0 w-8 h-8 bg-' + color + '-500 text-white rounded-full flex items-center justify-center font-bold">' + (idx + 1) + '</div><div class="flex-1"><div class="font-bold text-sm">' + record.STEP + ' - ' + record.UNIT + '</div><div class="text-xs text-gray-600 mt-1">مسئول: ' + record.PERSON + '</div><div class="text-xs text-gray-600">تاریخ: ' + record.RECEIVED_DATE.toLocaleDateString('fa-IR') + '</div>' + (record.DESCRIPTION ? '<div class="text-xs text-gray-500 mt-1">' + record.DESCRIPTION + '</div>' : '') + '</div><div class="text-left"><div class="font-bold text-lg text-' + color + '-700">' + days + '</div><div class="text-xs text-gray-500">روز</div></div></div>';
            });
            html += '</div>';
            document.getElementById('timelineContent').innerHTML = html;
            document.getElementById('timelineModal').style.display = 'flex';
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').style.display = 'none';
        }

        function showCriticalListModal() {
            const groupedByStep = {};
            criticalDocuments.forEach(doc => {
                if (!groupedByStep[doc.step]) groupedByStep[doc.step] = [];
                groupedByStep[doc.step].push(doc);
            });
            let html = '<div id="printableContent" style="max-width: 1000px; margin: 0 auto;">';
            html += '<div class="print-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; border: 2px solid #333; border-radius: 8px; page-break-after: avoid;">';
            html += '<div style="width: 90px; text-align: center; border-left: 2px solid #ddd; padding-left: 10px;"><img src="https://raw.githubusercontent.com/akarimvand/SAPRA2/main/images/SAPRA.png" alt="SAPRA" style="height: 50px; -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>';
            html += '<div style="text-align: center; padding: 0 10px;"><div style="font-size: 14px; font-weight: bold; margin-bottom: 3px; color: #333;">گزارش ساب سیستمهای بحرانی با تاخیر بالاتر از 14 روز</div><div style="font-size: 11px; margin-bottom: 3px; color: #555;">داشبورد مانیتورینگ گردش اسناد</div><div style="font-size: 10px; color: #666;">تعداد کل: <strong>' + criticalDocuments.length + '</strong> ساب سیستم</div></div>';
            html += '<div style="width: 100px; text-align: center; border-right: 2px solid #ddd; padding-right: 10px; font-size: 10px; color: #666;"><div style="margin-bottom: 3px;"><strong>تاریخ:</strong><br>' + new Date().toLocaleDateString('fa-IR') + '</div><div><strong>صفحه:</strong><br><span class="page-number"></span></div></div>';
            html += '</div>';
            Object.keys(groupedByStep).sort().forEach(step => {
                const docs = groupedByStep[step];
                html += '<div class="step-section" style="margin-bottom: 25px; page-break-inside: avoid;">';
                html += '<h2 style="background: #333; color: white; padding: 8px 12px; font-size: 16px; font-weight: bold; margin-bottom: 10px; margin-top: 0;">' + step + ' (' + docs.length + ' ساب سیستم)</h2>';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 11px;"><thead><tr style="background: #f5f5f5;">';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">#</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">ساب سیستم</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">واحد</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">مسئول</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">تاریخ دریافت</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">تاخیر (روز)</th>';
                html += '</tr></thead><tbody>';
                docs.sort((a, b) => b.daysInStage - a.daysInStage).forEach((doc, idx) => {
                    html += '<tr style="' + (idx % 2 === 0 ? 'background: #fafafa;' : '') + '">';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px;">' + (idx + 1) + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; font-weight: bold;">' + doc.subSystem + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px;">' + doc.unit + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px;">' + doc.person + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px;">' + doc.date.toLocaleDateString('fa-IR') + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; font-weight: bold; color: #333;">' + doc.daysInStage + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            });
            html += '</div>';
            document.getElementById('criticalListContent').innerHTML = html;
            document.getElementById('criticalListModal').style.display = 'flex';
        }

        function closeCriticalListModal() {
            document.getElementById('criticalListModal').style.display = 'none';
        }

        function printCriticalList() {
            window.print();
        }

        function showFullReport() {
            const matrixData = {};
            documentPaths.forEach((path) => {
                const lastRecord = path.records[path.records.length - 1];
                const key = lastRecord.STEP + '|' + lastRecord.UNIT;
                if (!matrixData[key]) matrixData[key] = 0;
                matrixData[key]++;
            });
            const allDocs = [];
            documentPaths.forEach((path, subSystem) => {
                const lastRecord = path.records[path.records.length - 1];
                const daysInStage = Math.ceil((new Date() - lastRecord.RECEIVED_DATE) / 86400000);
                allDocs.push({ subSystem, step: lastRecord.STEP, unit: lastRecord.UNIT, person: lastRecord.PERSON, date: lastRecord.RECEIVED_DATE, daysInStage, loops: path.loops });
            });
            allDocs.sort((a, b) => a.subSystem.localeCompare(b.subSystem));
            let html = '<div id="printableFullReport" style="max-width: 1000px; margin: 0 auto;">';
            html += '<div class="print-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; border: 2px solid #333; border-radius: 8px; page-break-after: avoid;">';
            html += '<div style="width: 90px; text-align: center; border-left: 2px solid #ddd; padding-left: 10px;"><img src="https://raw.githubusercontent.com/akarimvand/SAPRA2/main/images/SAPRA.png" alt="SAPRA" style="height: 50px; -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>';
            html += '<div style="text-align: center; padding: 0 10px;"><div style="font-size: 14px; font-weight: bold; margin-bottom: 3px; color: #333;">گزارش کامل وضعیت ساب سیستمها</div><div style="font-size: 11px; margin-bottom: 3px; color: #555;">داشبورد مانیتورینگ گردش اسناد</div><div style="font-size: 10px; color: #666;">تعداد کل: <strong>' + allDocs.length + '</strong> ساب سیستم</div></div>';
            html += '<div style="width: 100px; text-align: center; border-right: 2px solid #ddd; padding-right: 10px; font-size: 10px; color: #666;"><div style="margin-bottom: 3px;"><strong>تاریخ:</strong><br>' + new Date().toLocaleDateString('fa-IR') + '</div><div><strong>صفحه:</strong><br><span class="page-number"></span></div></div>';
            html += '</div>';
            html += '<div style="margin-bottom: 25px; page-break-after: always;"><h2 style="background: #333; color: white; padding: 8px 12px; font-size: 16px; font-weight: bold; margin-bottom: 10px; margin-top: 0;">ماتریس توزیع ساب سیستمها</h2>';
            const steps = [...new Set(allDocs.map(d => d.step))].sort();
            const unitsOrder = ['CONTRACTOR', 'PRECOM', 'TPA', 'OWNER'];
            const units = unitsOrder.filter(u => allDocs.some(d => d.unit === u));
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 11px;"><thead><tr style="background: #f5f5f5;"><th style="border: 1px solid #ddd; padding: 4px 6px; text-align: right;">مرحله / واحد</th>';
            units.forEach(unit => html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">' + unit + '</th>');
            html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center; background: #e0e0e0;">جمع</th></tr></thead><tbody>';
            steps.forEach(step => {
                html += '<tr><td style="border: 1px solid #ddd; padding: 3px 6px; font-weight: bold;">' + step + '</td>';
                let rowTotal = 0;
                units.forEach(unit => {
                    const key = step + '|' + unit;
                    const count = matrixData[key] || 0;
                    rowTotal += count;
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center; font-weight: bold;">' + (count > 0 ? count : '-') + '</td>';
                });
                html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center; font-weight: bold; background: #f0f0f0;">' + rowTotal + '</td></tr>';
            });
            html += '<tr style="background: #e0e0e0; font-weight: bold;"><td style="border: 1px solid #ddd; padding: 3px 6px;">جمع</td>';
            let grandTotal = 0;
            units.forEach(unit => {
                let colTotal = 0;
                steps.forEach(step => {
                    const key = step + '|' + unit;
                    colTotal += matrixData[key] || 0;
                });
                grandTotal += colTotal;
                html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + colTotal + '</td>';
            });
            html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center; background: #d0d0d0;">' + grandTotal + '</td></tr>';
            html += '</tbody></table></div>';
            const groupedByStep = {};
            allDocs.forEach(doc => {
                if (doc.step === 'Execution Activities') return;
                if (!groupedByStep[doc.step]) groupedByStep[doc.step] = [];
                groupedByStep[doc.step].push(doc);
            });
            Object.keys(groupedByStep).sort().forEach(stepKey => {
                const step = stepKey === 'Execution Activities' ? 'در حال تکمیل فعالیتهای اجرایی' : stepKey;
                const docs = groupedByStep[stepKey].sort((a, b) => a.subSystem.localeCompare(b.subSystem));
                html += '<div style="margin-bottom: 25px; page-break-inside: avoid;"><h2 style="background: #333; color: white; padding: 8px 12px; font-size: 16px; font-weight: bold; margin-bottom: 10px; margin-top: 0;">' + step + ' (' + docs.length + ' ساب سیستم)</h2>';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 11px;"><thead><tr style="background: #f5f5f5;">';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">#</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">ساب سیستم</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">واحد</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">مسئول</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">تاریخ دریافت</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">روز</th>';
                html += '<th style="border: 1px solid #ddd; padding: 4px 6px; text-align: center;">تعداد گردش</th>';
                html += '</tr></thead><tbody>';
                docs.forEach((doc, idx) => {
                    const delayIcon = doc.daysInStage > 14 ? ' <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>' : '';
                    html += '<tr style="' + (idx % 2 === 0 ? 'background: #fafafa;' : '') + '">';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + (idx + 1) + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center; font-weight: bold;">' + doc.subSystem + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + doc.unit + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + doc.person + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + doc.date.toLocaleDateString('fa-IR') + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + doc.daysInStage + delayIcon + '</td>';
                    html += '<td style="border: 1px solid #ddd; padding: 3px 6px; text-align: center;">' + doc.loops + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            });
            html += '</div>';
            document.getElementById('fullReportContent').innerHTML = html;
            document.getElementById('fullReportModal').style.display = 'flex';
        }

        function closeFullReportModal() {
            document.getElementById('fullReportModal').style.display = 'none';
        }

        function printFullReport() {
            window.print();
        }

        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const icon = document.getElementById('filterToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up text-gray-600';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down text-gray-600';
            }
        }

        loadData();
    </script>
</body>
</html>
