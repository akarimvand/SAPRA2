<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>فرم جستجوی Punch</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      padding: 1rem;
    }

    .container-form {
      max-width: 100%;
    }

    .form-control,
    .form-select {
      font-size: 0.875rem;
    }

    .data-grid {
      font-size: 0.875rem;
    }

    .btn-custom {
      font-size: 0.875rem;
    }

    .table-responsive {
      overflow-x: auto;
    }

    .card {
      margin-bottom: 1rem;
    }

    @media (min-width: 768px) {
      .container-form {
        max-width: 960px;
        margin: auto;
      }
    }

    @media (min-width: 992px) {
      .container-form {
        max-width: 1200px;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid container-form">
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <h5 class="mb-2 mb-md-0">جستجو و مدیریت Punch Items</h5>
        <div class="d-flex w-100 w-md-auto justify-content-end mt-2 mt-md-0">
          <button class="btn btn-primary btn-sm me-2 w-100 w-md-auto" id="sendBtn">
            <i class="bi bi-send me-1"></i> ارسال نتایج
          </button>
          <button class="btn btn-success btn-sm w-100 w-md-auto" id="exportExcelBtn">
            <i class="bi bi-file-earmark-excel me-1"></i> خروجی اکسل
          </button>
        </div>
      </div>
      <div class="card-body">
        <form id="punchFilterForm" class="mb-3">
          <div class="row g-3">
            <div class="col-12 col-md-3">
              <label for="filterSubsystem" class="form-label">Subsystem</label>
              <input type="text" class="form-control form-control-sm" id="filterSubsystem" placeholder="جستجو..." />
            </div>
            <div class="col-12 col-md-3">
              <label for="filterDiscipline" class="form-label">Discipline</label>
              <input type="text" class="form-control form-control-sm" id="filterDiscipline" placeholder="جستجو..." />
            </div>
            <div class="col-12 col-md-3">
              <label for="filterTagNo" class="form-label">Tag No</label>
              <input type="text" class="form-control form-control-sm" id="filterTagNo" placeholder="جستجو..." />
            </div>
            <div class="col-12 col-md-3">
              <label for="filterPunchCategory" class="form-label">دسته‌بندی</label>
              <select class="form-select form-select-sm" id="filterPunchCategory">
                <option value="">همه</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
            </div>
          </div>
        </form>
        <div class="table-responsive data-grid">
          <table class="table table-hover table-striped table-sm">
            <thead class="table-light">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Subsystem</th>
                <th scope="col">Discipline</th>
                <th scope="col">Tag No</th>
                <th scope="col">Type Code</th>
                <th scope="col">دسته</th>
                <th scope="col">شرح</th>
              </tr>
            </thead>
            <tbody id="punchDataTableBody">
              <!-- داده‌ها در اینجا قرار می‌گیرند -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const PUNCH_CSV_URL = "https://raw.githubusercontent.com/akarimvand/SAPRA2/refs/heads/main/PUNCH.CSV";
    let punchData = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadPunchData();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('punchFilterForm').addEventListener('input', applyFilters);
      document.getElementById('punchFilterForm').addEventListener('change', applyFilters);
      document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
      document.getElementById('sendBtn').addEventListener('click', sendResults);
    }

    function loadPunchData() {
      Papa.parse(PUNCH_CSV_URL, {
        header: true,
        download: true,
        skipEmptyLines: true,
        complete: (results) => {
          punchData = results.data.map(item => ({
            subsystem: item.SD_SUB_SYSTEM?.trim() || '',
            discipline: item.Discipline_Name?.trim() || '',
            tagNo: item.ITEM_Tag_NO?.trim() || '',
            typeCode: item.ITEM_Type_Code?.trim() || '',
            punchCategory: item.PL_Punch_Category?.trim() || '',
            punchDescription: item.PL_Punch_Description?.trim() || ''
          }));
          renderTable(punchData);
        },
        error: (err) => {
          console.error("خطا در بارگذاری CSV:", err);
        }
      });
    }

    function applyFilters() {
      const subsystem = document.getElementById('filterSubsystem').value.trim().toLowerCase();
      const discipline = document.getElementById('filterDiscipline').value.trim().toLowerCase();
      const tagNo = document.getElementById('filterTagNo').value.trim().toLowerCase();
      const category = document.getElementById('filterPunchCategory').value.trim().toLowerCase();

      const filtered = punchData.filter(item =>
        (item.subsystem.toLowerCase().includes(subsystem)) &&
        (item.discipline.toLowerCase().includes(discipline)) &&
        (item.tagNo.toLowerCase().includes(tagNo)) &&
        (category === '' || item.punchCategory.toLowerCase() === category)
      );

      renderTable(filtered);
    }

    function renderTable(data) {
      const tbody = document.getElementById('punchDataTableBody');
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">داده‌ای یافت نشد.</td></tr>`;
        return;
      }
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.subsystem}</td>
          <td>${item.discipline}</td>
          <td>${item.tagNo}</td>
          <td>${item.typeCode || 'N/A'}</td>
          <td>${item.punchCategory || 'N/A'}</td>
          <td>${item.punchDescription}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function exportToExcel() {
      if (punchData.length === 0) {
        alert("داده‌ای برای خروجی وجود ندارد.");
        return;
      }
      const worksheet = XLSX.utils.json_to_sheet(punchData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Punch Data');
      XLSX.writeFile(workbook, `Punch_Items_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function sendResults() {
      const selectedRows = Array.from(document.querySelectorAll('#punchDataTableBody tr')).filter(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        return checkbox && checkbox.checked;
      });
      if (selectedRows.length === 0) {
        alert("لطفاً حداقل یک ردیف را انتخاب کنید.");
        return;
      }
      const selectedData = selectedRows.map(row => {
        const cells = row.querySelectorAll('td');
        return {
          Subsystem: cells[1].textContent.trim(),
          Discipline: cells[2].textContent.trim(),
          TagNo: cells[3].textContent.trim(),
          TypeCode: cells[4].textContent.trim(),
          Category: cells[5].textContent.trim(),
          Description: cells[6].textContent.trim()
        };
      });
      // شبیه‌سازی ارسال به سرور یا برنامه دیگر
      console.log("ارسال داده‌ها:", selectedData);
      alert(`${selectedData.length} ردیف با موفقیت ارسال شد.`);
    }
  </script>
</body>
</html>
