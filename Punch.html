<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAPRA Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"  rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"  rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            padding: 1rem;
        }

        .container-form {
            max-width: 1200px;
            margin: auto;
        }

        .form-control,
        .form-select {
            font-size: 0.875rem;
        }

        .data-grid {
            font-size: 0.875rem;
        }

        .btn-group-top {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: end;
            margin-bottom: 1rem;
        }

        .btn-group-top .btn {
            flex: 1 1 calc(33% - 0.3rem);
            min-width: 140px;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .btn-group-top .btn {
                flex: 1 1 100%;
            }
        }

        .excel-template {
            border-collapse: collapse;
            width: 100%;
        }

        .excel-template th,
        .excel-template td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        .excel-template thead {
            background-color: #f0f0f0;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .card {
            margin-bottom: 1rem;
        }

        .slogan {
            font-size: 1rem;
            color: #adb5bd;
            animation: sloganAnimation 10s ease-in-out infinite alternate;
        }

        @keyframes sloganAnimation {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-3px); opacity: 0.9; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 320px;
            background-color: #343a40;
            color: #e9ecef;
            padding-top: 0;
            z-index: 1050;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content.sidebar-open {
                filter: blur(2px);
            }
        }

        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }

        @media (min-width: 992px) {
            .main-content {
                margin-left: 320px;
            }
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sapra-navbar-header .navbar-toggler-icon {
            filter: invert(1);
        }

        .card-header {
            background-color: #343a40;
            color: white;
        }

        .card-title-custom {
            font-size: 1.1rem;
        }

        .count-display {
            font-size: 3rem;
            font-weight: bold;
        }

        .icon-wrapper {
            padding: 0.375rem;
            border-radius: 0.375rem;
        }

        .gradient-form-a {
            background-color: #0078D7;
            color: white;
        }

        .gradient-form-b {
            background-color: #00B294;
            color: white;
        }

        .gradient-form-c {
            background-color: #FF8000;
            color: white;
        }

        .gradient-form-d {
            background-color: #A200FF;
            color: white;
        }

        .gradient-form-a:hover,
        .gradient-form-b:hover,
        .gradient-form-c:hover,
        .gradient-form-d:hover {
            transform: perspective(600px) translateY(8px) scale(1.03) rotateX(10deg);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            border-radius: 1.5rem 0.5rem 1.5rem 0.5rem/1.5rem 1.5rem 0.5rem 0.5rem;
        }

        .chart-container {
            height: 288px;
            position: relative;
        }

        .footer {
            font-size: 0.85rem;
            color: #adb5bd;
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(.4, 2, .6, 1);
        }

        .footer a {
            color: inherit;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .sapra-loader svg {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<div class="container-fluid container-form">
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
            <h5 class="mb-2 mb-md-0">Punch Items Management</h5>
            <div class="btn-group-top w-100 w-md-auto justify-content-end mt-2 mt-md-0">
                <button class="btn btn-primary" id="shareBtn">
                    <i class="bi bi-share me-1"></i> Share Results
                </button>
                <button class="btn btn-success" id="exportExcelBtn">
                    <i class="bi bi-file-earmark-excel me-1"></i> Export to Excel
                </button>
            </div>
        </div>
        <div class="card-body">
            <form id="punchFilterForm" class="mb-3">
                <div class="row g-3">
                    <div class="col-12 col-md-3">
                        <label for="filterSubsystem" class="form-label">Subsystem</label>
                        <input type="text" class="form-control form-control-sm" id="filterSubsystem" placeholder="Search...">
                    </div>
                    <div class="col-12 col-md-3">
                        <label for="filterDiscipline" class="form-label">Discipline</label>
                        <input type="text" class="form-control form-control-sm" id="filterDiscipline" placeholder="Search...">
                    </div>
                    <div class="col-12 col-md-3">
                        <label for="filterTagNo" class="form-label">Tag No</label>
                        <input type="text" class="form-control form-control-sm" id="filterTagNo" placeholder="Search...">
                    </div>
                    <div class="col-12 col-md-3">
                        <label for="filterPunchCategory" class="form-label">Category</label>
                        <select class="form-select form-select-sm" id="filterPunchCategory">
                            <option value="">All</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                </div>
            </form>
            <div class="table-responsive data-grid">
                <table class="table table-hover table-striped table-sm">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Subsystem</th>
                        <th scope="col">Discipline</th>
                        <th scope="col">Tag No</th>
                        <th scope="col">Type Code</th>
                        <th scope="col">Category</th>
                        <th scope="col">Description</th>
                    </tr>
                    </thead>
                    <tbody id="punchDataTableBody">
                    <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Hidden template for styled Excel export -->
<table id="excelTemplate" class="excel-template" style="display:none;">
    <thead>
    <tr>
        <th>#</th>
        <th>Subsystem</th>
        <th>Discipline</th>
        <th>Tag No</th>
        <th>Type Code</th>
        <th>Category</th>
        <th>Description</th>
    </tr>
    </thead>
    <tbody id="excelTemplateBody">
    <!-- Rows will be filled dynamically -->
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script> 
<script>
    const PUNCH_CSV_URL = "PUNCH.CSV";
    let punchData = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadPunchData();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('punchFilterForm').addEventListener('input', applyFilters);
        document.getElementById('punchFilterForm').addEventListener('change', applyFilters);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('shareBtn').addEventListener('click', shareResults);
    }

    function loadPunchData() {
        Papa.parse(PUNCH_CSV_URL, {
            header: true,
            download: true,
            skipEmptyLines: true,
            complete: (results) => {
                punchData = results.data.map(item => ({
                    subsystem: item.SD_SUB_SYSTEM?.trim() || '',
                    discipline: item.Discipline_Name?.trim() || '',
                    tagNo: item.ITEM_Tag_NO?.trim() || '',
                    typeCode: item.ITEM_Type_Code?.trim() || '',
                    punchCategory: item.PL_Punch_Category?.trim() || '',
                    punchDescription: item.PL_Punch_Description?.trim() || ''
                }));
                renderTable(punchData);
            },
            error: (err) => {
                console.error("Error loading CSV:", err);
            }
        });
    }

    function applyFilters() {
        const subsystem = document.getElementById('filterSubsystem').value.trim().toLowerCase();
        const discipline = document.getElementById('filterDiscipline').value.trim().toLowerCase();
        const tagNo = document.getElementById('filterTagNo').value.trim().toLowerCase();
        const category = document.getElementById('filterPunchCategory').value.trim().toLowerCase();

        const filtered = punchData.filter(item =>
            item.subsystem.toLowerCase().includes(subsystem) &&
            item.discipline.toLowerCase().includes(discipline) &&
            item.tagNo.toLowerCase().includes(tagNo) &&
            (category === '' || item.punchCategory.toLowerCase() === category)
        );

        renderTable(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('punchDataTableBody');
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No data found.</td></tr>`;
            return;
        }
        data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.subsystem}</td>
                <td>${item.discipline}</td>
                <td>${item.tagNo}</td>
                <td>${item.typeCode || 'N/A'}</td>
                <td>${item.punchCategory || 'N/A'}</td>
                <td>${item.punchDescription}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function exportToExcel() {
        const filteredData = getFilteredDataForExport();
        if (filteredData.length === 0) {
            alert("No data available for export.");
            return;
        }

        const worksheet = XLSX.utils.json_to_sheet(filteredData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Punch Data');
        XLSX.writeFile(workbook, `Punch_Items_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function getFilteredDataForExport() {
        const subsystem = document.getElementById('filterSubsystem').value.trim().toLowerCase();
        const discipline = document.getElementById('filterDiscipline').value.trim().toLowerCase();
        const tagNo = document.getElementById('filterTagNo').value.trim().toLowerCase();
        const category = document.getElementById('filterPunchCategory').value.trim().toLowerCase();

        return punchData.filter(item =>
            item.subsystem.toLowerCase().includes(subsystem) &&
            item.discipline.toLowerCase().includes(discipline) &&
            item.tagNo.toLowerCase().includes(tagNo) &&
            (category === '' || item.punchCategory.toLowerCase() === category)
        ).map((item, index) => ({
            '#': index + 1,
            Subsystem: item.subsystem,
            Discipline: item.discipline,
            'Tag No': item.tagNo,
            'Type Code': item.typeCode || 'N/A',
            Category: item.punchCategory || 'N/A',
            Description: item.punchDescription
        }));
    }

    function shareResults() {
        const selectedRows = Array.from(document.querySelectorAll('#punchDataTableBody tr')).filter(row => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            return checkbox && checkbox.checked;
        });

        if (selectedRows.length === 0) {
            alert("Please select at least one row.");
            return;
        }

        const selectedData = selectedRows.map(row => {
            const cells = row.querySelectorAll('td');
            return {
                Subsystem: cells[1].textContent.trim(),
                Discipline: cells[2].textContent.trim(),
                TagNo: cells[3].textContent.trim(),
                TypeCode: cells[4].textContent.trim(),
                Category: cells[5].textContent.trim(),
                Description: cells[6].textContent.trim()
            };
        });

        console.log("Sharing data:", selectedData);
        alert(`${selectedData.length} items shared successfully.`);
    }
</script>
</body>
</html>
